---
title: "Code Overview"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{overview}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: refs.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(AXEexamples)
library(tidyverse)
```

# Recreating paper examples

`data-raw/run_examples.R` contains the code to obtain MCV ground truth values and CV approximations for $E[Y_j | Y_{-j}]$ using the following LCO methods:

- AXE

- integrated importance sampling

   + iIS-C [@li2016approximating]
   
   + iIS-A [@vehtari2016bayesian]
   
- GHOST [@marshall2003approximate]

- PSIS-LOO [@vehtari2016practical] (in those cases that LOO-CV = LCO-CV)

As example, the eight schools example in the paper is recreated below:


```{r eightex, eval=FALSE}
# accesses and/or saves data for the example + scenario parameters
# e.g. data scaling factor alpha or number of clusters
eight <- prep_eight() # function in R/prep_data.R

# runs MCV and saves estimates; also records the time
# examine using str(eight$cv_yhats)
eight$cv_yhats  <- mcv_eight() # R/run_mcv.R

# fits models to full data and saves posterior means of variance parameters
eight$posteriors <- pfit_eight() #R/fit_posteriors.R

# runs AXE and saves estimates; also records the time
eight$axe_yhats <- axe_eight() #  R/run_axe.R

```

## Figure 1

All variance/covariance posterior means, LCO approximations, and MCV ground-truth values are bundled together in the `data` folder. 

To get the graphs used in the paper, first get results for each of the examples:

```{r resultsdfs, results = 'hide'}


eight_results <- results_eight() %>%  
  select(-contains("_iis_")) %>% group_by(loop, data_scale)
r1_results <- results_radon_full() %>% group_by(model, loop) %>%
    select(-contains("_iis_"), -yhat_axe2) # !!! Key step
r2_results <- results_radon_simul() %>% rename(yhat_cv = cv_yhat) %>%
    mutate(loop = interaction(model, perc, n_clusters, iter)) %>%
    group_by(model, perc, n_clusters, iter, loop) %>%
    # rename(yhat_psiis_im = yhat_psiis_im.value) %>%
    select(-yhat_post_axe, -yhat_post,-contains("_iis_"))
lol_results <-  results_lol() %>%  select(-contains("_iis_")) %>%
    group_by(loop) %>%
    mutate(n = n()) %>%
    group_by(loop, n) %>%
    select(-yhat_post) #%>%
slc_results <- results_slc() %>%  select(-contains("_iis_"), -yhat_post) %>%
    group_by(loop)
air_results <- results_air() %>%
    select(-yhat_post) %>% select(-contains("_iis_")) %>%
    group_by(loop)

```


Obtain each panel in Figure 1 individually.
```{r lrrfigs, fig.show = 'hide'}

p_8 <-  df_compare_methods(eight_results, "yhat") %>%
    mutate(
        alpha = case_when(data_scale < 1 ~ "low",
                          data_scale < 2 ~ "mid",
                          data_scale >= 2 ~ "high") %>%
            factor(levels = c("low", "mid", "high"), ordered = T)#,
    ) %>%
ggplot(aes(x = method, y = dif, fill = alpha)) +
    geom_boxplot() +
    theme_bw() +
    theme(
        legend.key.size = unit(0.75, "lines"),
        legend.background = element_rect(
            fill = alpha('white', 0))
    ) +
    labs(x = NULL, fill = NULL, y = NULL, title = "A) Eight schools") +
    scale_fill_brewer(palette = "BuGn", type = "seq",
                      # labels = scales::parse_format())+
                      labels = c(expression( alpha < 1),
                                 expression(1 <= {alpha < 2}),
                                 expression(alpha >= 2),
                                 expression(123456))) +
    geom_hline(yintercept = 0)

p_8 <- lemon::reposition_legend(p_8, position = "bottom left")

p_r1 <- ggplot(
    df_compare_methods(r1_results, "yhat"),
    aes(x = method, y = dif, fill = sprintf("Model %s", model))) +
    geom_boxplot() +
    theme_bw() +
    theme(
        legend.key.size = unit(0.75, "lines"),
        legend.background = element_rect(
            fill = alpha('white', 0))
    ) + 
  labs(x = NULL, fill = NULL, y = NULL, title = "B) Radon") +
    scale_fill_brewer(palette = "Set2") +
    geom_hline(yintercept = 0)
p_r1 <- lemon::reposition_legend(p_r1, position = "bottom left")


r2_cutoff <- data.frame(
    dif = -1,
    model = 3,
    method = c("GHOST", 'iIS-C')
)

p_r2 <- df_compare_methods(r2_results, "yhat") %>%
    ggplot(aes(x = method, y = dif)) +
    geom_boxplot(aes(fill = sprintf("Model %s", model))) +
    ylim(-1, 1) +
    geom_point(
        aes(group = model),
        position=position_nudge(x=.25),
        data = r2_cutoff, shape = 3
    ) +
    theme_bw() +
    theme(
        legend.key.size = unit(0.75, "lines"),
        legend.background = element_rect(
            fill = alpha('white', 0))
    ) +    
  labs(x = NULL, fill = NULL, y = NULL,
                         title = "C) Radon subsets") +
    scale_fill_brewer(palette = "Set2")+
    geom_hline(yintercept = 0)
p_r2 <- lemon::reposition_legend(p_r2, position = "bottom left")


p_lol <- df_compare_methods(lol_results, "yhat") %>% plot_compare_methods("yhat") +
  labs(y = NULL, title = "D) ESP")
p_slc <- df_compare_methods(slc_results, "yhat") %>% 
  plot_compare_methods("yhat") +
    labs(y = NULL, title = "E) SLC")
p_air <- df_compare_methods(air_results, "yhat") %>% 
  plot_compare_methods("yhat") +
    labs(y = NULL, subtitle = "F) SRD")


```

Plot together using the cowplot package.

```{r figure1, fig.width = 10, fig.height = 5}
library(cowplot)
plot_grid(p_8, p_r1, p_r2, p_lol, p_slc, p_air, nrow = 2)

```



## Figure 2

```{r resultsdfs2}
eight_results <- results_eight() %>%  
  select(-contains("_iis_")) %>% group_by(loop, data_scale)
r1_results <- results_radon_full() %>% group_by(model, loop) %>%
    select(-contains("_iis_"), -yhat_axe2) # !!! Key step
r2_results <- results_radon_simul() %>% rename(yhat_cv = cv_yhat) %>%
    mutate(loop = interaction(model, perc, n_clusters, iter)) %>%
    group_by(model, perc, n_clusters, iter, loop) %>%
    # rename(yhat_psiis_im = yhat_psiis_im.value) %>%
    select(-yhat_post_axe, -yhat_post,-contains("_iis_"))
lol_results <-  results_lol() %>%  select(-contains("_iis_")) %>%
    group_by(loop) %>%
    mutate(n = n()) %>%
    group_by(loop, n) %>%
    select(-yhat_post) #%>%
slc_results <- results_slc() %>%  select(-contains("_iis_"), -yhat_post) %>%
    group_by(loop)
srd_results <- results_air() %>%
    select(-yhat_post) %>% select(-contains("_iis_")) %>%
    group_by(loop)

```

Combine results into one DF
```{r combine}
datasets <- c("Eight schools", "Radon", "Radon subsets", "ESP", "SLC", "SRD")
yhats_all <- dplyr::bind_rows(
    purrr::map2(
        list(eight_results, r1_results, r2_results, lol_results, slc_results, air_results),
        as.list(datasets),
        function(df, dname) {
            df %>% dplyr::mutate(data = dname) %>%
                dplyr::ungroup() %>%
                dplyr::select(data, yhat_cv, yhat_axe, yhat_ghst_c, yhat_psiis_fm)
        }
    )
) %>%
    tidyr::pivot_longer(cols = c(yhat_axe, yhat_ghst_c, yhat_psiis_fm),
                        names_to = "method", values_to = "yhat") %>%

    dplyr::mutate(
        method = stringr::str_replace(method, "yhat_", "") %>%
            rename_methods(),
        data = factor(data, levels = datasets, ordered = T)
    )
```


```{r fig2subpanels, fig.show = 'height'}
#To keep the same axes across both panels, create data frame with min/max values. 
yhats_minmax <- yhats_all %>% dplyr::group_by(data) %>%
    dplyr::summarise(min = min(yhat), max = max(yhat), yhat_cv = yhat_cv[1]) %>%
    tidyr::pivot_longer(cols = c(min, max), names_to = "range", values_to = "yhat")

ptbypt_axe <-
    yhats_all %>% filter(method == "AXE") %>%
    ggplot(aes(x = yhat_cv, y = yhat)) +
    theme_bw() +
    geom_point() +
    lemon::facet_rep_wrap(~data, scales = 'free', nrow = 1) +
    labs(y = "AXE approximation", x = "MCV estimate") +
    geom_abline(slope = 1, intercept = 0) +
    theme(
        strip.background = element_rect(size = 0, fill = 'white'),
        strip.text = element_text(hjust = 0, size = 12)
    ) +
    # invisible points at each data set's min/max to keep y-axis consistent
    geom_point(data = yhats_minmax, alpha = 0)



colors <-  RColorBrewer::brewer.pal(6, "Dark2")[4:6]



p <- yhats_all %>%
    filter(method != "iIS-A") %>%
    ggplot(aes(x = yhat_cv, y = yhat)) +
    geom_point(aes(color = method, shape = method)) +
    scale_color_manual(values = c("black", colors)) +
    labs(y = "LCO Approximation", x = "MCV estimate",
                  color = NULL, shape = NULL) +

    theme_bw() +
    lemon::facet_rep_wrap(~data, scales = 'free', nrow = 1) +
    geom_abline(slope = 1, intercept = 0) +
    theme_bw() +
    theme(
        legend.key.size = unit(0.3, "lines"),
        legend.background = element_rect(
            fill = alpha('white', 0)
        ),
        strip.background = element_rect(size = 0, fill = 'white'),
        strip.text = element_text(hjust = 0, size = 12)
    ) +
    geom_point(data = yhats_minmax, alpha = 0)


```


```{r fig2, fig.width = 10, fig.height = 5}

cowplot::plot_grid(
    ptbypt_axe,
    lemon::reposition_legend(
        p, panel = "panel-1-1", position = 'top left', offset = c(0, -0.1)
    ),
    ncol = 1, labels = sprintf("%s)", LETTERS[1:2])
)
```


# References

